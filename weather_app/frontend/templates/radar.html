{% extends 'template/main.html' %} 
{% load static %} 
{% block header %}
    <link rel="stylesheet" href="{% static '//css//landing.css' %}">
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script> -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
{% endblock %}
{% block content %}
    <style>
        body {
            overflow-y: hidden !important;
        }
        #map {
            position: absolute;
            top: 0;
            z-index: -10;
            bottom: 0;
            width: calc(100vw - 50px);
            right: 0;
            height: calc(100vh + 30px);
            overflow-y: hidden !important;
        }
    </style>
    <div id="map"></div>
    <script>
        mapboxgl.accessToken = "{{ mapbox_access_token }}";

        const API_KEY = "{{ tomorrowio_api_key }}";

        // pick the field (like temperature, precipitationIntensity or cloudCover)
        const DATA_FIELD = 'precipitationIntensity';

        // set the ISO timestamp (now for all fields, up to 6 hour out for precipitationIntensity)
        const TIMESTAMP = (new Date()).toISOString();

        if '{{ location.lat}}' == 'None' || '{{ location.lng}}' == 'None' {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                });
            }
        } else {
            var latitude = '{{ location.lat}}';
            var longitude = '{{ location.lng}}';
        }
        

        // initialize the map
        var map = (window.map = new mapboxgl.Map({
        container: 'map',
        zoom: 7,
        center: [latitude, longitude],
        style: 'mapbox://styles/nathan-perrier23/clr7bpszt00ls01ob5pxjboov', //mapbox://styles/nathan-perrier23/clqthibtm00ci01pp38f03g3w
        antialias: true
        }));

        // inject the tile layer
        map.on('load', function() {
        map.addSource('tomorrow-io-api', {
            "type": 'raster',
            "tiles": [`https://api.tomorrow.io/v4/map/tile/{z}/{x}/{y}/${DATA_FIELD}/${TIMESTAMP}.png?apikey=${API_KEY}`],
            "tileSize": 256,
            "attribution": '&copy; <a href="http://127.0.0.1:8000/atc/">Powered by Ambrose Treacy College</a>'
        });
        map.addLayer({
            "id": "radar-tiles",
            "type": "raster",
            "source": "tomorrow-io-api",
            "minzoom": 1,
            "maxzoom": 12
        });
        });
    </script>

    {% include 'chatbot/chat.html' %}
{% endblock %}