{% extends 'template/main.html' %} 
{% load static %} 
{% load date_extras %}
{% block header %}
  <link rel="stylesheet" href="{% static '//css//landing.css' %}">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
{% endblock %}
{% block content %}
  <div id="welcome-screen" class="wow fadeOut" data-wow-delay="1.4s" style="position: fixed; width: 100%; height: 100%; top: 0; left: 0; background: #000; display: none; align-items: center; justify-content: center; z-index: 9999;">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <h1 class="text-white header-text pt-0 ml-0 mt-0 wow fadeInLeftBig" style="overflow-x:hidden;font-family: Tungsten;font-size: 7rem;letter-spacing: -0.375rem; font-weight: 700;word-wrap: break-word; padding:0; margin-top: 0;">Rain<span style="color:var(--secondary)">Check</span></h1>
      <h2 class="pb-0 wow fadeInRightBig" style="color: #B9BBB9; font-size: 1.25rem; font-family: Netflix Sans; font-weight: 500; letter-spacing: 0.5rem; word-wrap: break-word; margin-bottom: 0;">POWERED BY AMBROSE TREACY COLLEGE</h2>
    </div>
  </div>

  <div class="" style="position: absolute">
  <!-- video -->
    <div class="hero-background pt-0 mt-0">
      <section class="hero-header">
        <div class="content pt-3">
          <section class="left">
            <div class="datetime-div">
              <div class="datetime-divider"></div>
              <div class="ms-2 datetime">
                <span id="time"></span>
                <br/>
                <span id="date"></span>
              </div>
            </div> 
            <div class="location-header">
              <h2 class="pt-5 mb-0 pb-0 font-netflix-medium wow fadeIn country-text" data-wow-delay="2s">{{ location.country|upper|default:"AUSTRALIA" }}</h2>
              <h1 class="text-white header-text pt-0 ml-0 mt-0 wow slideInLeft font-tungston-bold">{{ location.city|upper|default:"BRISBANE" }}</h1>
            </div>
            <div class="current-weather">
              <div class="icon d-flex">
                <div class="icon-img">
                  {% with icon_path='//images//weatherIcons//static//'|add:forecast_hourly.0.icon_descriptor|add:'.svg' %}
                    <img src="{% static icon_path %}" alt="weather icon">
                  {% endwith %}
                </div>
                <span class="temp">{{ weather_desc }}</span>
              </div>
              <div class="text">
                <div class="temp">
                  <span>{{ forecast_hourly.0.temp }}°C</span> 
                </div>
              </div>
            </div>
            <div class="weather-data mt-2"> <!-- add .weather-data to css-->
                <span>{{ forecast_daily.0.extended_text }}</span>
            </div>
          </section>         
        </div>
      </section>
      <section class="weather-app-home-video">
          <div class="left"></div>
          <div class="left-2"></div>
          <div class="top"></div>
          <div class="bottom"></div>
          <img src="{% static '//images//brisbane.jpg' %}" alt="">
          <!-- <video autoplay muted loop>
            <source src="{% url 'stream_video' video_path='video.mp4' %}" type="video/mp4">
              Your browser does not support the video tag.
          </video> -->
        </section>
      
    </div>
  <!-- video -->

    <!-- sliders -->
    <div class="slider-box" >
      <div class="container-fluid mb-0 p-0 ps-0 slide1">
        <section class="d-flex justify-content-between margin-right margin-title">
          <p class="mt-2 text-white font-netflix-bold"> <b>6 Day Forecast</b> </p>
          <div> <!-- why?? -->
            <button  type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active tab-change-btn" aria-current="true" aria-label="Slide 1"></button>
            <button class="tab-change-btn" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
          </div>
        </section>
        <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
          <div class="carousel-inner" style="position: relative; overflow: visible;width: calc(100vw - 60px)" >
            {% for day in forecast_daily %}
              {% if forloop.counter|divisibleby:4 or forloop.first %}
                {% if not forloop.first %}
                  </div>
                {% endif %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                  <section class='d-flex'>
              {% endif %}
                  {% if day.now %} <!-- doesn't work because day.date time is not current-->
                  <div class="weather-card card current-day" style="margin-right:10px">
                  {% else %}
                  <div class="weather-card card" style="{% if forloop.counter|divisibleby:4 %}margin-right:10px{% else %}margin: 0 10px{% endif %}">
                  {% endif %}
                    <div class="content">
                      <div class="top-info">
                          <span class="day">
                            {% if day.now %}
                              Today
                            {% else %}
                              {{ day.date }}
                            {% endif %}
                          </span>
                          {% if day.now %}
                            <span class="temp">{{ day.now.temp_now }}°C</span>
                          {% else %}
                            <span class="temp">
                              {% if day.temp_min %}
                                {{ day.temp_min }}/
                              {% endif %}
                              {{day.temp_max}}°C
                            </span>
                          {% endif %}
                      </div>
                      <div class="icon">
                        {% if day.icon_descriptor == 'partly_cloudy' or day.icon_descriptor == 'mostly_sunny' or day.icon_descriptor == 'cloudy' %}
                            <div class="highlight" style="background-color:#fff"></div>
                        {% elif day.icon_descriptor == 'heavy_shower' or day.icon_descriptor == 'light_shower' or day.icon_descriptor == 'fog' or day.icon_descriptor == 'light_rain' or day.icon_descriptor == 'shower' or day.icon_descriptor == 'rain' or day.icon_descriptor == 'snow' or day.icon_descriptor == 'windy' or day.icon_descriptor == 'frost' %}
                            <div class="highlight" style="background-color:#56a0ee"></div>
                        {% elif day.icon_descriptor == 'hazy' or day.icon_descriptor == 'dusty' %}
                            <div class="highlight" style="background-color:#cd9e73"></div>
                        {% elif day.icon_descriptor == 'sunny' or day.icon_descriptor == 'clear' %}
                            <div class="highlight" style="background-color:#ffa500"></div>
                        {% else %}
                            <div class="highlight" style="background-color:#ff0000"></div>
                        {% endif %}
                        {% with icon_path='//images//weatherIcons//static//'|add:day.icon_descriptor|add:'.svg' %}
                          
                            <img src="{% static icon_path %}" alt="Weather Icon">
                        {% endwith %}
                      </div>
                      <div class="description mt-0">{{ day.short_text }}</div>
                      <div class="bottom-info">
                        <span class="humidity">Rain: {{ day.rain.chance }}%</span>
                        {% if day.now %}
                          {% if day.now.is_night %}
                            <span class="aqi">Nightime</span>
                          {% else %}
                            <span class="aqi">Daytime</span>
                          {% endif %}
                        {% else %}
                          <span class="aqi">UV: {{ day.uv.max_index }}</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
              {% if forloop.last %}
                </section>
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <!-- sliders-end -->

    <!--<div class="carousel-item {% if forloop.first %}active{% endif %} d-flex">
      <section class='d-flex'>-->

    <div class="mt-2 location-container">
      <div class="left">
        <div class="location-header" style="text-align: left;">
          <p class="mt-1 mb-1 p-0 text-white font-netflix-bold text" style="text-align: left;"> 
              <b>{{ location.city }} Radar</b> 
          </p>
        </div>
        <div class="radar p-2 pt-0 pr-0">
          <div id="map"></div>
        </div>
      </div>
      <div class="right p-2">
        <div class="locations">
        
        </div>
      </div>
    </div>

  </div>

  {% include 'chatbot/chat.html' %}

  <script src="{% static '//js//landing.js' %}"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <script>    
    window.onload = function () {
      // Check if the cookie indicating the welcome screen has been shown exists
      if (document.cookie.indexOf('welcomeScreenShown=true') === -1) {
          document.getElementById('welcome-screen').style.display = 'flex';
          // If not, execute the code
          setTimeout(function () {
              document.getElementById('welcome-screen').style.display = 'none';
  
              var date = new Date();
              date.setDate(date.getDate() + 1); // Set the date to one day in the future
              document.cookie = 'welcomeScreenShown=true; expires=' + date.toUTCString() + '; path=/';
          }, 1600);
      } else {
        document.getElementById('welcome-screen').style.display = 'none';
      }
    };
  

    function getGeoLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            return {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            }
        });
      } else {
        return {
          latitude: 153.02207,
          longitude: -27.46917
        }
      }
    }

    fetch('http://worldtimeapi.org/api/ip')
    .then(response => response.json())
    .then(data => {
        const datetime = new Date(data.datetime);
        document.getElementById('date').textContent = datetime.toLocaleDateString();
        const timeOptions = { hour: '2-digit', minute: '2-digit' };
        document.getElementById('time').textContent = datetime.toLocaleTimeString([], timeOptions);
        document.getElementById('divider').removeClass('hide');
        document.getElementById('timedate').removeClass('hide');
        document.getElementById('timedate').addClass('wow');
        document.getElementById('timedate').addClass('slideInLeft');
    })
    .catch((error) => {
        console.error('Error:', error);
    });
  
    mapboxgl.accessToken = "{{ mapbox_access_token }}";

    const API_KEY = "{{ tomorrowio_api_key }}";

    // pick the field (like temperature, precipitationIntensity or cloudCover)
    const DATA_FIELD = 'precipitationIntensity';

    // set the ISO timestamp (now for all fields, up to 6 hour out for precipitationIntensity)
    const TIMESTAMP = (new Date()).toISOString();

    var latitude = 153.02207;
    var longitude = -27.46917;
    if ('{{ location }}') {
      latitude = '{{ location.lon }}';
      longitude = '{{ location.lat }}';
    } else {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
              latitude = position.coords.latitude;
              longitude = position.coords.longitude;
          });
      }
    }; 
  

    // initialize the map
    var map = (window.map = new mapboxgl.Map({
      container: 'map',
      zoom: 7,
      center: [latitude, longitude],
      style: 'mapbox://styles/nathan-perrier23/clr7wfpx6000101ood22cfm8u', //* 'mapbox://styles/nathan-perrier23/clqthibtm00ci01pp38f03g3w',   ------ LEGACY ------
      antialias: true
    }));

    // inject the tile layer
    map.on('load', function() {
      map.addSource('tomorrow-io-api', {
          "type": 'raster',
          "tiles": [`https://api.tomorrow.io/v4/map/tile/{z}/{x}/{y}/${DATA_FIELD}/${TIMESTAMP}.png?apikey=${API_KEY}`],
          "tileSize": 256,
          "attribution": '&copy; <a href="http://127.0.0.1:8000/atc/">Powered by Ambrose Treacy College</a>'
      });
      map.addLayer({
          "id": "radar-tiles",
          "type": "raster",
          "source": "tomorrow-io-api",
          "minzoom": 1,
          "maxzoom": 12
      });
    });
  </script>
{% endblock %}  